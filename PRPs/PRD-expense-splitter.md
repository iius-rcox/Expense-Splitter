---
name: "PDF Transaction Matcher & Splitter - Product Requirements Document"
version: "1.0"
created: "2025-10-16"
project_id: "4cfa897d-906c-481a-8d7f-6435a634060b"
---

# PDF Transaction Matcher & Splitter - Product Requirements Document

## Executive Summary

### Product Vision
A desktop application that automates expense report processing by intelligently matching corporate credit card transactions with their corresponding receipts, then generating organized PDF packages for accounting and compliance purposes.

### Target Users
- **Primary**: Corporate employees who need to submit expense reports with matched receipts
- **Secondary**: Accounting departments processing expense submissions
- **Tertiary**: Finance managers reviewing expense compliance

### Core Value Proposition
Eliminate 80% of manual effort in matching receipts to credit card transactions, reducing a 2-hour monthly task to 15 minutes while ensuring 100% accuracy and compliance.

---

## Problem Statement

### Current Pain Points

**For Employees:**
- Spend 1-2 hours monthly manually matching receipts to credit card statements
- Risk missing receipts leading to non-reimbursable expenses
- Tedious process of scanning through pages to find matching transactions
- Errors in matching lead to rejected expense reports

**For Accounting:**
- Receive incomplete or incorrectly matched expense submissions
- Must manually verify each transaction-receipt pair
- Difficult to audit and ensure compliance
- Time-consuming back-and-forth with employees for corrections

**For Finance:**
- Lack of visibility into expense processing efficiency
- Difficult to identify patterns of missing receipts
- Compliance risks from incomplete documentation

### Market Gap
Existing expense management solutions (Expensify, Concur) require full cloud adoption and monthly subscriptions. Many organizations need a lightweight, one-time-use desktop tool for occasional expense processing without ongoing costs or data privacy concerns.

---

## Product Overview

### What We're Building

A standalone desktop application that:

1. **Accepts two PDF inputs:**
   - CAR (Corporate American Express Report) PDF
   - Receipt collection PDF (scanned receipts)

2. **Extracts transaction data** from both PDFs using intelligent text parsing

3. **Matches transactions** using a weighted algorithm considering:
   - Transaction date (±1 day tolerance)
   - Amount (exact match)
   - Employee ID
   - Merchant name (fuzzy matching)

4. **Generates split PDFs** where each output contains:
   - Corresponding CAR page(s) for a transaction
   - Matching receipt page(s)
   - Combined into a single PDF file per matched pair

5. **Provides review interface** showing:
   - Confidence scores for each match
   - Side-by-side comparison of CAR and receipt data
   - Manual override capabilities for edge cases

### What We're NOT Building

- ❌ Cloud-based SaaS platform
- ❌ Mobile applications
- ❌ Real-time synchronization with corporate systems
- ❌ Multi-user collaboration features
- ❌ Integration with accounting software (future consideration)
- ❌ OCR for handwritten receipts (typed/printed text only)

---

## User Personas

### Persona 1: Sarah - Corporate Sales Manager

**Demographics:**
- 35 years old, travels 10 days/month
- Submits expense reports monthly
- Tech-savvy, values efficiency

**Goals:**
- Minimize time spent on expense reports
- Ensure all receipts are matched correctly
- Avoid rejected submissions

**Pain Points:**
- Has 30-50 transactions per month to match
- Often loses paper receipts while traveling
- Dreads the manual matching process

**Use Case:**
At month-end, Sarah downloads her CAR PDF from Amex portal, scans her collected receipts into a single PDF, then uses the app to automatically match and generate submission packages in 15 minutes instead of 2 hours.

### Persona 2: David - Accounting Specialist

**Demographics:**
- 42 years old, processes 50+ expense reports monthly
- Moderate technical skills
- Detail-oriented, compliance-focused

**Goals:**
- Quickly verify expense submissions are complete
- Ensure policy compliance
- Reduce back-and-forth with employees

**Pain Points:**
- Receives poorly organized expense submissions
- Spends hours manually verifying matches
- Frustrated by preventable errors

**Use Case:**
David receives expense submissions generated by the app with pre-matched transactions, allowing him to spot-check high-confidence matches and focus audit time on low-confidence or flagged items.

---

## Functional Requirements

### FR1: PDF Upload & Validation

**Priority**: P0 (Must Have)

**Description**: Users can upload CAR and receipt PDFs with validation

**Acceptance Criteria:**
- [ ] Support drag-and-drop or file browser selection
- [ ] Accept only valid PDF files (reject corrupted or password-protected)
- [ ] Display file size and page count
- [ ] Show upload progress for files >5MB
- [ ] Validate minimum 1 page, maximum 500 pages per PDF
- [ ] Provide clear error messages for invalid files

**User Flow:**
1. User opens application
2. Drags CAR PDF into "CAR Upload" zone
3. Drags receipt PDF into "Receipt Upload" zone
4. System validates both files
5. System displays file metadata and proceeds to extraction

**Error Handling:**
- Invalid PDF format → "Unable to read PDF. Please ensure file is not corrupted or password-protected."
- File too large → "PDF exceeds 500 page limit. Please split into smaller files."
- No transactions found → "No parseable transactions found. Please verify PDF contains text (not scanned images)."

---

### FR2: Transaction Extraction

**Priority**: P0 (Must Have)

**Description**: Extract transaction data from CAR and receipt PDFs using regex patterns

**Acceptance Criteria:**
- [ ] Parse CAR PDFs for: date, amount, merchant, employee ID, card last 4 digits, page number
- [ ] Parse receipt PDFs for: date, amount, merchant, page number
- [ ] Handle multiple date formats (MM/DD/YYYY, DD-MMM-YYYY, etc.)
- [ ] Handle currency formats ($1,234.56, $1234.56, 1234.56)
- [ ] Extract data from multi-column layouts
- [ ] Maintain page number references for each transaction
- [ ] Process PDFs with 100+ transactions in <30 seconds

**Data Model - CAR Transaction:**
```python
{
    "transaction_id": "uuid",
    "date": "2025-10-15",
    "amount": 142.50,
    "merchant": "DELTA AIR LINES",
    "employee_id": "EMP12345",
    "card_last_4": "1234",
    "page_number": 2,
    "raw_text": "Original line from PDF",
    "source_pdf": "car_2025_10.pdf"
}
```

**Data Model - Receipt Transaction:**
```python
{
    "transaction_id": "uuid",
    "date": "2025-10-15",
    "amount": 142.50,
    "merchant": "Delta Airlines",
    "page_number": 5,
    "raw_text": "Original line from PDF",
    "source_pdf": "receipts_october.pdf"
}
```

**Regex Patterns:**

CAR PDF Pattern Examples:
```regex
Date: \d{2}/\d{2}/\d{4}|\d{2}-[A-Z]{3}-\d{4}
Amount: \$?\d{1,3}(,?\d{3})*\.\d{2}
Merchant: [A-Z][A-Z0-9\s\-\.]{3,50}
Employee ID: [A-Z]{3}\d{4,6}|EMP\d{4,6}
```

**Edge Cases:**
- Multi-line merchant names → Concatenate to single field
- Negative amounts (credits/refunds) → Flag for manual review
- Missing employee ID → Extract from document header
- Duplicate transactions on same date → Maintain separate records

**Performance Requirements:**
- Extract 100 transactions in <30 seconds
- Support PDFs up to 500 pages
- Memory usage <500MB for typical workload

---

### FR3: Transaction Matching Algorithm

**Priority**: P0 (Must Have)

**Description**: Match CAR transactions with receipt transactions using weighted scoring

**Acceptance Criteria:**
- [ ] Calculate match confidence score (0-100%)
- [ ] Apply weighted criteria: date (30%), amount (30%), employee ID (25%), merchant (15%)
- [ ] Set minimum confidence threshold at 70%
- [ ] Return multiple potential matches if confidence >50%
- [ ] Flag unmatched transactions from both sources
- [ ] Support 1-to-1 matching only (no split transactions)
- [ ] Process 100 transaction pairs in <10 seconds

**Matching Logic:**

**Date Matching (30% weight):**
```python
def calculate_date_score(car_date, receipt_date):
    delta = abs((car_date - receipt_date).days)
    if delta == 0: return 1.0  # Same day = 100%
    if delta == 1: return 0.8  # 1 day off = 80%
    if delta == 2: return 0.5  # 2 days off = 50%
    return 0.0  # >2 days = 0%
```

**Amount Matching (30% weight):**
```python
def calculate_amount_score(car_amount, receipt_amount):
    if abs(car_amount - receipt_amount) < 0.01:  # Exact match
        return 1.0
    return 0.0  # No partial credit for close amounts
```

**Employee ID Matching (25% weight):**
```python
def calculate_employee_score(car_emp_id, receipt_emp_id):
    # Receipt PDFs may not have employee ID
    if receipt_emp_id is None:
        return 1.0  # Don't penalize missing receipt employee ID
    if car_emp_id == receipt_emp_id:
        return 1.0
    return 0.0
```

**Merchant Matching (15% weight):**
```python
def calculate_merchant_score(car_merchant, receipt_merchant):
    # Use fuzzy string matching (Levenshtein distance)
    similarity = fuzz.token_sort_ratio(car_merchant, receipt_merchant) / 100
    return similarity  # 0.0 to 1.0
```

**Overall Confidence Score:**
```python
confidence = (
    date_score * 0.30 +
    amount_score * 0.30 +
    employee_score * 0.25 +
    merchant_score * 0.15
) * 100  # Convert to percentage
```

**Match Classification:**
- **High Confidence**: ≥85% → Auto-approve eligible
- **Medium Confidence**: 70-84% → Review recommended
- **Low Confidence**: 50-69% → Manual verification required
- **No Match**: <50% → Flagged as unmatched

**Output - Match Result:**
```python
{
    "match_id": "uuid",
    "car_transaction_id": "uuid",
    "receipt_transaction_id": "uuid",
    "confidence_score": 87.5,
    "score_breakdown": {
        "date": 30.0,    # 100% match * 30% weight
        "amount": 30.0,  # 100% match * 30% weight
        "employee": 25.0,  # 100% match * 25% weight
        "merchant": 12.5   # 83% match * 15% weight
    },
    "classification": "high",
    "status": "auto_approved",
    "created_at": "2025-10-16T10:30:00Z"
}
```

**Edge Cases:**
- Multiple receipts for same CAR transaction → Return all potential matches, require manual selection
- Split transactions → Flag for manual handling (future enhancement)
- Duplicate amounts on same date → Rely on merchant matching to disambiguate

---

### FR4: Match Review Interface

**Priority**: P0 (Must Have)

**Description**: Display matched transactions with confidence scores and allow manual review

**Acceptance Criteria:**
- [ ] Show side-by-side comparison of CAR and receipt data
- [ ] Display confidence score and breakdown
- [ ] Color-code matches: Green (≥85%), Yellow (70-84%), Red (<70%)
- [ ] Allow manual approval/rejection of matches
- [ ] Allow manual pairing of unmatched transactions
- [ ] Filter by confidence level
- [ ] Sort by date, amount, or confidence
- [ ] Display total matched vs. unmatched counts

**UI Components:**

**Match List View:**
```
+----------------------------------------------------------------------+
| Matches: 42 matched | 3 unmatched CAR | 2 unmatched receipts        |
+----------------------------------------------------------------------+
| Filter: [All] [High Conf.] [Medium] [Low] [Unmatched]               |
| Sort: [Date ▼] [Amount] [Confidence]                                |
+----------------------------------------------------------------------+
| ✓ | 87% | Oct 15 | $142.50 | DELTA AIR    | Delta Airlines     | → |
| ✓ | 92% | Oct 14 | $45.00  | UBER TRIP    | Uber Technologies  | → |
| ⚠ | 73% | Oct 12 | $89.99  | AMAZON.COM   | Amazon Marketplace | → |
| ✗ | 52% | Oct 10 | $25.00  | SHELL GAS    | Shell Station 123  | → |
+----------------------------------------------------------------------+
```

**Match Detail View (click row to expand):**
```
+----------------------------------------------------------------------+
| Match Confidence: 87% [████████████████░░░░] High                    |
+----------------------------------------------------------------------+
| CAR Transaction              | Receipt                               |
|------------------------------|---------------------------------------|
| Date: 10/15/2025             | Date: October 15, 2025                |
| Amount: $142.50              | Amount: $142.50                       |
| Merchant: DELTA AIR LINES    | Merchant: Delta Airlines              |
| Employee: EMP12345           | Employee: —                           |
| Card: •••• 1234              | —                                     |
| Page: 2                      | Page: 5                               |
|------------------------------|---------------------------------------|
| Score Breakdown:                                                     |
| Date Match: 30/30 (Same day)                                         |
| Amount Match: 30/30 (Exact)                                          |
| Employee Match: 25/25 (Matched)                                      |
| Merchant Match: 12.5/15 (83% similarity)                             |
+----------------------------------------------------------------------+
| [Approve Match] [Reject Match] [View PDFs]                           |
+----------------------------------------------------------------------+
```

**Actions:**
- Approve Match → Mark for PDF splitting
- Reject Match → Return both transactions to unmatched pool
- View PDFs → Display side-by-side page previews from source PDFs

**Unmatched Transactions View:**
```
+----------------------------------------------------------------------+
| Unmatched CAR Transactions (3)                                       |
+----------------------------------------------------------------------+
| Oct 18 | $67.50 | STARBUCKS COFFEE | EMP12345 | [Find Match]        |
| Oct 16 | $12.00 | UBER EATS        | EMP12345 | [Find Match]        |
| Oct 11 | $200.00| HOTEL BOOKING    | EMP12345 | [Find Match]        |
+----------------------------------------------------------------------+
| Unmatched Receipts (2)                                               |
+----------------------------------------------------------------------+
| Oct 19 | $34.99 | Best Buy Store   | [Find Match]                  |
| Oct 13 | $8.50  | Subway Restaurant| [Find Match]                  |
+----------------------------------------------------------------------+
```

**Manual Matching:**
- Click "Find Match" on unmatched transaction
- Show potential matches sorted by partial confidence
- Allow dragging CAR transaction to receipt to create manual match

---

### FR5: PDF Splitting & Export

**Priority**: P0 (Must Have)

**Description**: Extract matched page ranges and combine into export PDFs

**Acceptance Criteria:**
- [ ] Generate one PDF per matched pair
- [ ] Include CAR page(s) followed by receipt page(s)
- [ ] Preserve original page quality and formatting
- [ ] Name files: `match_{employee_id}_{date}_{merchant}_{amount}.pdf`
- [ ] Sanitize filenames (remove special characters)
- [ ] Store exports in `/exports/{session_id}/` directory
- [ ] Support batch export of all approved matches
- [ ] Display export progress for large batches
- [ ] Generate manifest file listing all exports

**Export Process:**

1. **User triggers export:**
   - "Export All Approved" button
   - "Export Selected" for manually chosen matches
   - Individual export from match detail view

2. **System processing:**
   - Create session directory: `/exports/session_20251016_103045/`
   - For each match:
     - Extract CAR page(s) from source PDF
     - Extract receipt page(s) from source PDF
     - Combine into new PDF: CAR pages first, receipt pages second
     - Save with standardized filename

3. **Filename generation:**
```python
def generate_filename(match):
    employee_id = match.car_transaction.employee_id
    date = match.car_transaction.date.strftime('%Y%m%d')
    merchant = sanitize(match.car_transaction.merchant)[:20]
    amount = f"{match.car_transaction.amount:.2f}".replace('.', '_')

    return f"match_{employee_id}_{date}_{merchant}_{amount}.pdf"

# Example: match_EMP12345_20251015_DELTA_AIR_LINES_142_50.pdf
```

4. **Manifest file:**
```json
{
  "session_id": "session_20251016_103045",
  "created_at": "2025-10-16T10:30:45Z",
  "total_exports": 42,
  "exports": [
    {
      "filename": "match_EMP12345_20251015_DELTA_AIR_LINES_142_50.pdf",
      "match_id": "uuid",
      "confidence_score": 87.5,
      "car_pages": [2],
      "receipt_pages": [5],
      "status": "success"
    }
  ]
}
```

5. **User feedback:**
   - Progress bar during batch export
   - Success notification with export directory path
   - Option to open export folder in file explorer
   - Summary: "Exported 42 matches to /exports/session_20251016_103045/"

**Edge Cases:**
- Multi-page CAR transaction → Include all pages in sequence
- Multi-page receipt → Include all pages in sequence
- Export failure → Log error, continue with remaining matches, report failures in manifest

---

### FR6: Data Persistence

**Priority**: P1 (Should Have)

**Description**: Store extraction and matching data in local database

**Acceptance Criteria:**
- [ ] Use SQLite for local storage
- [ ] Store transactions, matches, and PDF metadata
- [ ] Support session recovery (reload previous work)
- [ ] Enable undo/redo for manual match operations
- [ ] Maintain audit trail of match approvals/rejections
- [ ] Support multiple sessions (keep last 10 sessions)
- [ ] Database file: `data/expense_matcher.db`

**Database Schema:**

```sql
-- PDF uploads
CREATE TABLE pdfs (
    id TEXT PRIMARY KEY,
    filename TEXT NOT NULL,
    file_path TEXT NOT NULL,
    pdf_type TEXT CHECK(pdf_type IN ('car', 'receipt')),
    page_count INTEGER,
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Extracted transactions
CREATE TABLE transactions (
    id TEXT PRIMARY KEY,
    pdf_id TEXT REFERENCES pdfs(id),
    transaction_type TEXT CHECK(transaction_type IN ('car', 'receipt')),
    date DATE NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    merchant TEXT NOT NULL,
    employee_id TEXT,
    card_last_4 TEXT,
    page_number INTEGER NOT NULL,
    raw_text TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Matches
CREATE TABLE matches (
    id TEXT PRIMARY KEY,
    car_transaction_id TEXT REFERENCES transactions(id),
    receipt_transaction_id TEXT REFERENCES transactions(id),
    confidence_score DECIMAL(5,2),
    score_breakdown JSON,
    classification TEXT CHECK(classification IN ('high', 'medium', 'low')),
    status TEXT CHECK(status IN ('pending', 'approved', 'rejected')),
    match_type TEXT CHECK(match_type IN ('auto', 'manual')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Export history
CREATE TABLE exports (
    id TEXT PRIMARY KEY,
    match_id TEXT REFERENCES matches(id),
    filename TEXT NOT NULL,
    file_path TEXT NOT NULL,
    exported_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Sessions for recovery
CREATE TABLE sessions (
    id TEXT PRIMARY KEY,
    car_pdf_id TEXT REFERENCES pdfs(id),
    receipt_pdf_id TEXT REFERENCES pdfs(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_accessed TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Session Recovery:**
- On app launch, show "Recent Sessions" if any exist
- User can click to reload previous work
- All transactions, matches, and approvals restored
- Continue from where they left off

---

## Non-Functional Requirements

### NFR1: Performance

**Target Metrics:**
- PDF upload validation: <2 seconds for 300MB file
- Transaction extraction: <30 seconds for 100 transactions
- Matching algorithm: <10 seconds for 100 transaction pairs
- PDF splitting: <5 seconds per matched pair
- UI responsiveness: <100ms for user interactions
- Memory usage: <500MB under typical workload

**Stress Testing:**
- Support 500-page PDFs
- Handle 200+ transactions per PDF
- Process batch export of 100 matches in <5 minutes

### NFR2: Usability

**Design Principles:**
- Minimal learning curve (first-time users productive in <5 minutes)
- Clear visual feedback for all operations
- Intuitive drag-and-drop interactions
- Accessible color-blind-friendly color scheme
- Responsive layout (minimum 1280x720 resolution)

**Error Messages:**
- User-friendly language (no technical jargon)
- Actionable guidance (tell user what to do next)
- Contextual help tooltips

### NFR3: Reliability

**Uptime:**
- Offline-capable (no internet required)
- No external dependencies after installation
- Graceful handling of corrupted PDFs

**Data Integrity:**
- Atomic operations (transaction matching all-or-nothing)
- Auto-save progress every 30 seconds
- Database backup before destructive operations

**Error Recovery:**
- Crash recovery (restore last saved session)
- Detailed error logging to `/logs/` directory
- User-facing error reports with log file location

### NFR4: Security

**Data Privacy:**
- All data stored locally (no cloud uploads)
- No telemetry or analytics collection
- Secure file deletion option (overwrite before delete)

**File Handling:**
- Validate PDF structure before processing
- Sandbox PDF parsing (prevent malicious PDF execution)
- Temporary files cleaned up on session end

### NFR5: Compatibility

**Operating Systems:**
- Windows 10/11 (primary target)
- macOS 11+ (secondary)
- Linux Ubuntu 20.04+ (tertiary)

**PDF Support:**
- PDF versions 1.4 through 2.0
- Text-based PDFs (not scanned image PDFs)
- Unencrypted PDFs only

### NFR6: Maintainability

**Code Quality:**
- Type hints for all Python functions
- Unit test coverage >80%
- Linting with ruff (zero warnings)
- Type checking with mypy (strict mode)

**Documentation:**
- API documentation for all public functions
- Architecture decision records (ADRs)
- User guide with screenshots

---

## Technical Architecture

### System Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Electron Desktop App                      │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              Frontend (React + TypeScript)              │ │
│  │  ┌──────────────────────────────────────────────────┐  │ │
│  │  │  Components: Upload, MatchReview, Export         │  │ │
│  │  │  State: TanStack Query (React Query v5)          │  │ │
│  │  │  Styling: Tailwind CSS + shadcn/ui               │  │ │
│  │  └──────────────────────────────────────────────────┘  │ │
│  └────────────────────────────────────────────────────────┘ │
│                            │                                  │
│                            │ HTTP REST API                    │
│                            ▼                                  │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              Backend (FastAPI + Python)                 │ │
│  │  ┌──────────────────────────────────────────────────┐  │ │
│  │  │  API Routes: /upload, /extract, /match, /export  │  │ │
│  │  │  Services: Extraction, Matching, Splitting       │  │ │
│  │  │  PDF Libraries: pdfplumber, PyPDF2               │  │ │
│  │  └──────────────────────────────────────────────────┘  │ │
│  └────────────────────────────────────────────────────────┘ │
│                            │                                  │
│                            │ SQLAlchemy ORM                   │
│                            ▼                                  │
│  ┌────────────────────────────────────────────────────────┐ │
│  │            SQLite Database (Local Storage)              │ │
│  │         Tables: pdfs, transactions, matches, exports    │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ File System
                            ▼
            ┌─────────────────────────────────┐
            │  /data/        (SQLite DB)      │
            │  /uploads/     (Temp PDFs)      │
            │  /exports/     (Output PDFs)    │
            │  /logs/        (Error logs)     │
            └─────────────────────────────────┘
```

### Technology Stack

**Frontend:**
- React 18+ (UI framework)
- TypeScript 5 (type safety)
- Vite (build tool)
- TanStack Query v5 (server state management)
- Tailwind CSS (styling)
- shadcn/ui (component library)

**Backend:**
- Python 3.11+
- FastAPI (web framework)
- SQLAlchemy 2.0 (ORM)
- Pydantic v2 (validation)
- pdfplumber (text extraction)
- PyPDF2 (PDF manipulation)
- rapidfuzz (fuzzy string matching)

**Desktop:**
- Electron (app wrapper)
- PyInstaller (Python bundling)

**Database:**
- SQLite (development and production)

**Testing:**
- pytest (backend unit tests)
- React Testing Library (frontend tests)

### API Specification

**Base URL:** `http://localhost:8000/api`

#### POST /upload/car
Upload CAR PDF file

**Request:**
```
Content-Type: multipart/form-data
file: <binary PDF data>
```

**Response:**
```json
{
  "pdf_id": "550e8400-e29b-41d4-a716-446655440000",
  "filename": "car_2025_10.pdf",
  "page_count": 15,
  "uploaded_at": "2025-10-16T10:30:00Z"
}
```

#### POST /upload/receipt
Upload receipt PDF file

**Request:**
```
Content-Type: multipart/form-data
file: <binary PDF data>
```

**Response:**
```json
{
  "pdf_id": "660e8400-e29b-41d4-a716-446655440001",
  "filename": "receipts_october.pdf",
  "page_count": 23,
  "uploaded_at": "2025-10-16T10:31:00Z"
}
```

#### POST /extract/transactions
Extract transactions from uploaded PDFs

**Request:**
```json
{
  "car_pdf_id": "550e8400-e29b-41d4-a716-446655440000",
  "receipt_pdf_id": "660e8400-e29b-41d4-a716-446655440001"
}
```

**Response:**
```json
{
  "car_transactions": 47,
  "receipt_transactions": 45,
  "extraction_time_ms": 2341,
  "status": "success"
}
```

#### POST /match/transactions
Run matching algorithm on extracted transactions

**Request:**
```json
{
  "car_pdf_id": "550e8400-e29b-41d4-a716-446655440000",
  "receipt_pdf_id": "660e8400-e29b-41d4-a716-446655440001",
  "confidence_threshold": 70.0
}
```

**Response:**
```json
{
  "total_matches": 42,
  "high_confidence": 35,
  "medium_confidence": 7,
  "low_confidence": 0,
  "unmatched_car": 5,
  "unmatched_receipts": 3,
  "matching_time_ms": 487,
  "status": "success"
}
```

#### GET /matches
Retrieve all matches with details

**Query Parameters:**
- `car_pdf_id` (required)
- `receipt_pdf_id` (required)
- `min_confidence` (optional, default: 0)
- `classification` (optional: high|medium|low)
- `status` (optional: pending|approved|rejected)

**Response:**
```json
{
  "matches": [
    {
      "match_id": "770e8400-e29b-41d4-a716-446655440002",
      "confidence_score": 87.5,
      "classification": "high",
      "status": "approved",
      "car_transaction": {
        "date": "2025-10-15",
        "amount": 142.50,
        "merchant": "DELTA AIR LINES",
        "employee_id": "EMP12345",
        "page_number": 2
      },
      "receipt_transaction": {
        "date": "2025-10-15",
        "amount": 142.50,
        "merchant": "Delta Airlines",
        "page_number": 5
      },
      "score_breakdown": {
        "date": 30.0,
        "amount": 30.0,
        "employee": 25.0,
        "merchant": 12.5
      }
    }
  ],
  "total": 42
}
```

#### PATCH /matches/{match_id}
Update match status (approve/reject)

**Request:**
```json
{
  "status": "approved"
}
```

**Response:**
```json
{
  "match_id": "770e8400-e29b-41d4-a716-446655440002",
  "status": "approved",
  "updated_at": "2025-10-16T10:45:00Z"
}
```

#### POST /matches/manual
Create manual match between unmatched transactions

**Request:**
```json
{
  "car_transaction_id": "880e8400-e29b-41d4-a716-446655440003",
  "receipt_transaction_id": "990e8400-e29b-41d4-a716-446655440004"
}
```

**Response:**
```json
{
  "match_id": "aa0e8400-e29b-41d4-a716-446655440005",
  "confidence_score": 45.0,
  "classification": "low",
  "status": "approved",
  "match_type": "manual"
}
```

#### POST /split/pdf
Generate split PDFs for approved matches

**Request:**
```json
{
  "match_ids": [
    "770e8400-e29b-41d4-a716-446655440002",
    "aa0e8400-e29b-41d4-a716-446655440005"
  ]
}
```

**Response:**
```json
{
  "session_id": "session_20251016_103045",
  "total_exports": 2,
  "export_path": "/exports/session_20251016_103045/",
  "manifest_file": "/exports/session_20251016_103045/manifest.json",
  "status": "success"
}
```

#### GET /download/{match_id}
Download individual split PDF

**Response:**
```
Content-Type: application/pdf
Content-Disposition: attachment; filename="match_EMP12345_20251015_DELTA_AIR_LINES_142_50.pdf"

<binary PDF data>
```

---

## Implementation Phases

### Phase 1: Foundation (Week 1-2)
**Goal:** Set up development environment and core infrastructure

**Tasks:**
- [ ] Setup backend environment (Python venv, dependencies)
- [ ] Setup frontend environment (Node.js, React, Vite)
- [ ] Implement database models (SQLAlchemy)
- [ ] Create basic FastAPI application structure
- [ ] Create basic React application structure
- [ ] Implement PDF upload endpoints
- [ ] Implement file validation logic

**Deliverables:**
- Working development environment
- Basic app that accepts PDF uploads
- Database schema created

**Success Criteria:**
- Can upload PDFs through UI
- PDFs stored in `/uploads/` directory
- Metadata saved to database

---

### Phase 2: PDF Processing (Week 3-4)
**Goal:** Extract and store transaction data

**Tasks:**
- [ ] Implement pdfplumber text extraction
- [ ] Create regex patterns for CAR PDFs
- [ ] Create regex patterns for receipt PDFs
- [ ] Implement transaction parsing service
- [ ] Store extracted transactions in database
- [ ] Create transaction display UI
- [ ] Handle edge cases (multi-line merchants, various date formats)

**Deliverables:**
- Transaction extraction service
- UI displaying extracted transactions
- Unit tests for extraction logic

**Success Criteria:**
- Successfully extract 95%+ of transactions from sample PDFs
- Handle various date and currency formats
- Display transactions in UI table

---

### Phase 3: Matching Algorithm (Week 5-6)
**Goal:** Implement intelligent matching with confidence scores

**Tasks:**
- [ ] Implement weighted matching algorithm
- [ ] Implement fuzzy merchant matching
- [ ] Calculate confidence scores
- [ ] Classify matches (high/medium/low)
- [ ] Store matches in database
- [ ] Create match review UI
- [ ] Implement manual match creation
- [ ] Implement match approval/rejection

**Deliverables:**
- Working matching algorithm
- Match review interface
- Confidence score visualization

**Success Criteria:**
- 90%+ of obvious matches have ≥85% confidence
- UI clearly shows match quality
- Users can manually override automatic matches

---

### Phase 4: PDF Splitting & Export (Week 7-8)
**Goal:** Generate and export matched PDF packages

**Tasks:**
- [ ] Implement PyPDF2 page extraction
- [ ] Implement PDF combination logic
- [ ] Create filename generation logic
- [ ] Implement batch export functionality
- [ ] Create export progress UI
- [ ] Generate export manifest
- [ ] Implement export history tracking

**Deliverables:**
- PDF splitting service
- Export functionality
- Export progress tracking

**Success Criteria:**
- Generate correct PDFs with CAR + receipt pages
- Batch export of 50+ matches in <2 minutes
- Clear filenames and organized export directory

---

### Phase 5: Polish & Testing (Week 9-10)
**Goal:** Refine UX, fix bugs, comprehensive testing

**Tasks:**
- [ ] Implement session recovery
- [ ] Add keyboard shortcuts
- [ ] Improve error handling and messaging
- [ ] Write comprehensive unit tests (>80% coverage)
- [ ] Perform end-to-end testing with real data
- [ ] Fix identified bugs
- [ ] Performance optimization
- [ ] Create user documentation

**Deliverables:**
- Polished UI/UX
- Comprehensive test suite
- User guide documentation

**Success Criteria:**
- All core workflows complete without errors
- Test coverage >80%
- User guide covers all features

---

### Phase 6: Desktop Packaging (Week 11-12)
**Goal:** Create standalone desktop application

**Tasks:**
- [ ] Setup Electron wrapper
- [ ] Configure PyInstaller for backend bundling
- [ ] Create application installers (Windows .exe, macOS .dmg)
- [ ] Test installation on clean machines
- [ ] Create uninstaller
- [ ] Setup auto-update mechanism (optional)

**Deliverables:**
- Windows installer
- macOS installer
- Installation guide

**Success Criteria:**
- Single-click installation works
- App runs without Python/Node.js pre-installed
- Clean uninstallation

---

## Success Metrics

### User Metrics
- **Time Savings**: Reduce expense matching from 2 hours to <15 minutes (87.5% reduction)
- **Accuracy**: >95% of high-confidence matches are correct
- **Adoption**: 80% of target users prefer app over manual process
- **Error Rate**: <5% of submitted expense reports rejected due to matching errors

### Technical Metrics
- **Performance**: Process 100 transactions in <30 seconds
- **Reliability**: <1% crash rate during normal operation
- **Test Coverage**: >80% unit test coverage
- **Code Quality**: Zero linting errors, zero type errors

### Business Metrics
- **User Satisfaction**: >4.0/5.0 rating
- **Support Burden**: <2 support tickets per 100 users
- **Edge Case Handling**: >90% of edge cases handled gracefully

---

## Risks & Mitigations

### Risk 1: PDF Format Variability
**Impact**: High | **Probability**: High

**Description:** CAR and receipt PDFs may have inconsistent formats that break regex patterns.

**Mitigation:**
- Collect sample PDFs during requirements phase
- Create comprehensive test suite with real-world samples
- Implement pattern fallbacks for common variations
- Provide manual override for unparseable PDFs
- Build pattern library that grows over time

---

### Risk 2: Matching Accuracy
**Impact**: High | **Probability**: Medium

**Description:** Algorithm may produce too many false positives or false negatives.

**Mitigation:**
- Iterate on confidence threshold based on user feedback
- Allow manual match creation/override
- Display confidence breakdown so users understand scores
- Track match accuracy metrics in production
- A/B test different weighting schemes

---

### Risk 3: Performance with Large PDFs
**Impact**: Medium | **Probability**: Medium

**Description:** 500-page PDFs may cause memory issues or slow processing.

**Mitigation:**
- Implement streaming PDF processing (page-by-page)
- Set maximum page limits
- Show progress indicators for long operations
- Optimize regex patterns for performance
- Profile and optimize bottlenecks

---

### Risk 4: User Adoption
**Impact**: High | **Probability**: Low

**Description:** Users may find app too complex or prefer manual process.

**Mitigation:**
- Conduct user testing with target personas
- Iterate on UI based on feedback
- Create video tutorials and documentation
- Ensure UI is intuitive (5-minute learning curve)
- Provide gradual onboarding

---

### Risk 5: Platform Compatibility
**Impact**: Medium | **Probability**: Low

**Description:** Electron/PyInstaller packaging may fail on some OS versions.

**Mitigation:**
- Test on multiple OS versions early
- Use well-supported packaging tools
- Provide fallback web-based version
- Document system requirements clearly

---

## Open Questions

### Q1: Split Transaction Handling
**Question:** How should we handle situations where one receipt covers multiple CAR transactions (e.g., hotel bill with multiple charges)?

**Options:**
1. Flag as unmatched, require manual intervention
2. Allow 1-to-many matching with special UI
3. Out of scope for v1.0

**Decision:** Option 1 for v1.0 (flag for manual review)

---

### Q2: Receipt Scanning Quality
**Question:** What if receipts are scanned as images without OCR?

**Options:**
1. Require text-based PDFs only
2. Integrate OCR library (Tesseract)
3. Recommend external OCR preprocessing

**Decision:** Option 1 for v1.0, Option 2 for v2.0

---

### Q3: Multi-Employee Support
**Question:** Can one upload contain transactions for multiple employees?

**Options:**
1. Single employee per session only
2. Support multiple employees with filtering
3. Auto-detect and separate by employee

**Decision:** Option 2 (support multiple employees, filter in UI)

---

### Q4: Export Format
**Question:** Should we support formats other than PDF (e.g., ZIP of images)?

**Options:**
1. PDF only
2. Add ZIP export option
3. Add individual image export

**Decision:** Option 1 for v1.0

---

## Appendix A: Sample Data

### Sample CAR PDF Format
```
CORPORATE AMERICAN EXPRESS CARD REPORT
Statement Period: 10/01/2025 - 10/31/2025
Employee: John Smith (EMP12345)
Card: •••• •••• •••• 1234

Date       Merchant                          Amount
-----------------------------------------------------------
10/15/25   DELTA AIR LINES                   $142.50
10/14/25   UBER TRIP                         $45.00
10/12/25   AMAZON.COM                        $89.99
10/10/25   SHELL GAS #12345                  $52.34
```

### Sample Receipt PDF Format
```
Delta Airlines
E-Ticket Receipt

Date: October 15, 2025
Passenger: John Smith
Flight: DL1234 JFK → LAX

Base Fare:        $120.00
Taxes & Fees:     $22.50
Total:            $142.50

Payment: Amex •••• 1234
```

---

## Appendix B: Glossary

**CAR**: Corporate American Express Report - Monthly statement PDF showing all credit card transactions

**Confidence Score**: Percentage (0-100%) indicating likelihood of correct match

**Export Package**: Combined PDF containing CAR page(s) and receipt page(s) for a single transaction

**Fuzzy Matching**: String comparison allowing for minor differences (e.g., "Delta Air Lines" vs "DELTA AIR LINES")

**Manual Match**: User-created match between transactions, overriding automatic algorithm

**Receipt PDF**: Scanned or digital receipts combined into a single PDF file

**Session**: Single instance of processing a CAR and receipt PDF pair

**Transaction**: Individual expense entry extracted from CAR or receipt PDF

**Unmatched Transaction**: Transaction without a corresponding match in the other PDF

---

## Document History

| Version | Date       | Author | Changes                       |
|---------|------------|--------|-------------------------------|
| 1.0     | 2025-10-16 | Claude | Initial PRD creation          |

---

**END OF DOCUMENT**
